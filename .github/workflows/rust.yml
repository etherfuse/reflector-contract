name: "Check PR"

on:
  pull_request:
  push:
    branches:
      - main
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  Check_Build:
    name: "Check Build"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install mise
        uses: jdx/mise-action@v2
      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2.7.3
      - name: "Install WASM Target"
        run: rustup target add wasm32-unknown-unknown
      - name: "Build Contract (Optimized)"
        run: cargo build --locked --profile release --target wasm32-unknown-unknown

  Check_Tests:
    name: "Run Tests with Coverage"
    runs-on: ubuntu-latest
    env:
      CARGO_LLVM_COV_VERSION: 0.6.13
      MIN_COVERAGE: 90
    steps:
      - uses: actions/checkout@v4
      - name: Install mise
        uses: jdx/mise-action@v2
      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2.7.3
      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --version ${{ env.CARGO_LLVM_COV_VERSION }} --locked
      - name: "Check Coverage Threshold"
        run: |
          COVERAGE=$(cargo llvm-cov --all-features --workspace --summary-only | grep -oE '[0-9]+\.[0-9]+%' | head -1 | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          echo "Minimum required: ${MIN_COVERAGE}%"
          if (( $(echo "$COVERAGE < $MIN_COVERAGE" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below minimum threshold of ${MIN_COVERAGE}%"
            exit 1
          else
            echo "✅ Coverage ${COVERAGE}% meets minimum threshold of ${MIN_COVERAGE}%"
          fi
